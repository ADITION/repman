- name: Create ssh directory
  become_user: "{{ system_user }}"
  file:
    path: "~/.ssh"
    state: directory
    owner: "{{ system_user }}"
    group: "{{ system_user }}"
    mode: 0700

- name: Install deploy key
  become_user: "{{ system_user }}"
  template:
    src: ~/.ssh/id_rsa
    dest: ~/.ssh/deploy_key
    mode: 0400

- name: Install ssh config
  become_user: "{{ system_user }}"
  template:
    src: config
    dest: ~/.ssh/config
    mode: 0644

- name: Create project directory
  file:
    path: "{{ app_root }}"
    state: directory
    owner: "{{ system_user }}"
    group: "{{ system_user }}"
    mode: 0755

- name: Fetch files from git
  become_user: "{{ system_user }}"
  git:
    repo: "{{ app_git_repo }}"
    dest: "{{ app_root }}"
    version: "{{ app_git_branch }}"
    accept_hostkey: yes
    force: yes
    key_file: ~/.ssh/deploy_key
    ssh_opts: "-o StrictHostKeyChecking=no"

- name: Install composer dependencies
  become_user: "{{ system_user }}"
  composer: command=install working_dir="{{ app_root }}" no_dev=yes optimize_autoloader=yes
